---
title: "Following Best Practices for Using eBird Data Tutorial"
output: 
  pdf_document:
    latex_engine: xelatex
---

When looking for machine and statistical learning project, I ran across [Best Practices for Using eBird Data](https://cornelllabofornithology.github.io/ebird-best-practices/index.html). It walks through using random forest to predict bird encounter rates for a given species in a given region.  To properly understand this, I'm walking through the tutorial.

<<<<<<< HEAD
# Introduction

=======
>>>>>>> 8ddaf72676f352482826582b05ee6c0209c69ffa
```{e}
install.packages("remotes")
remotes::install_github("mstrimas/ebppackages")
```

This didn't work, so I assume that we'll be using _rebird_ and _auk_ and import the packages as we come acorss them.

<<<<<<< HEAD
```{r}
library(dplyr)
library(auk)
library(sf)
library(rnaturalearth)
library(tidyselect)
```

This recommends getting the full ebird text file, but that is very large.  We instead requested data on Northern Cardinal sightings in Illinois.

Set the path to our data
```{r}
# set ebd path
auk_set_ebd_path("data/raw/ebd")
```

I got errors while trying to install 'sf', and used the following to resolve it:
* https://community.rstudio.com/t/configuration-failed-for-package-units/76417
  * sudo apt install libudunits2-dev
* https://mothergeo-py.readthedocs.io/en/latest/development/how-to/gdal-ubuntu-pkg.html
* https://stackoverflow.com/questions/44973639/trouble-installing-sf-due-to-gdal 
  * gdalinfo --version
  * sudo apt install gdalinfo

Replace bird conservation area code 27 with 22, which includes Chicago.
```{r}
# file to save spatial data
gpkg_dir <- "../data/raw"
if (!dir.exists(gpkg_dir))(
  dir.create(gpkg_dir)
)

f_ne <- file.path(gpkg_dir,"gis-data.gpkg")

#download bcrs
# tmp_dir <- normalizePath(tempdir())
# tmp_bcr <- file.path(tmp_dir, "bcr.zip")
# paste0("https://www.birdscanada.org/research/gislab/download/", 
#        "bcr_terrestrial_shape.zip") %>% 
#   download.file(destfile = tmp_bcr)
# unzip(tmp_bcr, exdir = tmp_dir)
bcr <- file.path("../data/raw", "BCR_Terrestrial_master_International.shp") %>%
  read_sf() %>%
  select(bcr_code = BCR, bcr_name = LABEL) %>%
  dplyr::filter(bcr_code == 22)

```

The Birds Canada links have changed, so I went to [the site](https://www.birdscanada.org/bird-science/nabci-bird-conservation-regions/) and downlaoded the terrestrial shape file directly instead.

# eBird Data

Switching in the name of the file I have
```{r}
library(auk)
library(lubridate)
library(sf)
library(gridExtra)
library(tidyverse)
# resolve namespace conflicts
select <- dplyr::select

# setup data directory
dir.create("../data/raw/ebd", showWarnings = FALSE)

# ebd <- auk_ebd("ebd_relSep-2019.txt", 
#                file_sampling = "ebd_sampling_relSep-2019.txt")

ebd <- auk_ebd("ebd_US_norcar_relOct-2020.txt")

```

```{r}

# political boundaries
# land border with lakes removed
ne_land <- ne_download(scale = 50, category = "cultural",
                       type = "admin_0_countries_lakes",
                       returnclass = "sf") %>%
  filter(CONTINENT == "North America") %>%
  st_set_precision(1e6) %>%
  st_union()
# country lines
# downloaded globally then filtered to north america with st_intersect()
ne_country_lines <- ne_download(scale = 50, category = "cultural",
                                type = "admin_0_boundary_lines_land",
                                returnclass = "sf") %>% 
  st_geometry()
ne_country_lines <- st_intersects(ne_country_lines, ne_land, sparse = FALSE) %>%
  as.logical() %>%
  {ne_country_lines[.]}
# states, north america
ne_state_lines <- ne_download(scale = 50, category = "cultural",
                              type = "admin_1_states_provinces_lines",
                              returnclass = "sf") %>%
  filter(adm0_a3 %in% c("USA", "CAN")) %>%
  mutate(iso_a2 = recode(adm0_a3, USA = "US", CAN = "CAN")) %>% 
  select(country = adm0_name, country_code = iso_a2)


# output
unlink(f_ne)
write_sf(ne_land, f_ne, "ne_land")
write_sf(ne_country_lines, f_ne, "ne_country_lines")
write_sf(ne_state_lines, f_ne, "ne_state_lines")
write_sf(bcr, f_ne, "bcr")
```

The map of bird conservation areas can be seen [here](https://nabci-us.org/resources/bird-conservation-regions-map/).
```{r}
ebd_filters <- ebd %>% 
  auk_species("Northern cardinal") %>% 
  # Eastern Tallgrass Prairie bcr
  auk_bcr(bcr = 22) %>% 
  # june, use * to get data from any year
  auk_date(date = c("*-06-01", "*-06-30")) %>% 
  # restrict to the standard traveling and stationary count protocols
  auk_protocol(protocol = c("Stationary", "Traveling")) %>% 
  auk_complete()
ebd_filters

```

```{r}
# output files
data_dir <- "../data/processed"
if (!dir.exists(data_dir)) {
  dir.create(data_dir)
}
f_ebd <- file.path(data_dir, "ebd_cardinal_june_bcr22.txt")
# f_sampling <- file.path(data_dir, "ebd_checklists_june_bcr27.txt")

# only run if the files don't already exist
# if (!file.exists(f_ebd)) {
#   auk_filter(ebd_filters, file = f_ebd, file_sampling = f_sampling)
# }

if (!file.exists(f_ebd)) {
  auk_filter(ebd_filters, file = f_ebd)
}

```

```{r}
# ebd_zf <- auk_zerofill(f_ebd, f_sampling, collapse = TRUE)
ebd_zf <- read_ebd(f_ebd)
ebd_zf
```

```{r}
# function to convert time observation to hours since midnight
time_to_decimal <- function(x) {
  x <- hms(x, quiet = TRUE)
  hour(x) + minute(x) / 60 + second(x) / 3600
}

# clean up variables
ebd_zf <- ebd_zf %>% 
  mutate(
    # convert X to NA
    observation_count = if_else(observation_count == "X", 
                                NA_character_, observation_count),
    observation_count = as.integer(observation_count),
    # effort_distance_km to 0 for non-travelling counts
    effort_distance_km = if_else(protocol_type != "Traveling", 
                                 0, effort_distance_km),
    # convert time to decimal hours since midnight
    time_observations_started = time_to_decimal(time_observations_started),
    # split date into year and day of year
    year = year(observation_date),
    day_of_year = yday(observation_date)
  )

```

## 2.4 Accounting for variation in detectability

```{r}
ebd_zf_filtered <- ebd_zf %>% 
  filter(
    # effort filters
    duration_minutes <= 5 * 60,
    effort_distance_km <= 5,
    # last 10 years of data
    year >= 2010,
    # 10 or fewer observers
    number_observers <= 10)

ebd_zf_filtered <- ebd_zf_filtered %>%
  mutate(species_observed = case_when(observation_count > 1 ~ TRUE, TRUE ~ FALSE))
```

```{r}
ebird <- ebd_zf_filtered %>% 
  select(checklist_id, observer_id, sampling_event_identifier,
         scientific_name,
         observation_count, species_observed, 
         state_code, locality_id, latitude, longitude,
         protocol_type, all_species_reported,
         observation_date, year, day_of_year,
         time_observations_started, 
         duration_minutes, effort_distance_km,
         number_observers)
write_csv(ebird, "../data/processed/ebd_cardinal_june_bcr22_zf.csv", na = "")
```

## 2.5 Exploratory analysis and visualization

```{r}
head(ebird)

# load and project gis data
map_proj <- st_crs(102003)
ne_land <- read_sf("../data/raw/gis-data.gpkg", "ne_land") %>% 
  st_transform(crs = map_proj) %>% 
  st_geometry()
bcr <- read_sf("data/gis-data.gpkg", "bcr") %>% 
  st_transform(crs = map_proj) %>% 
  st_geometry()
ne_country_lines <- read_sf("data/gis-data.gpkg", "ne_country_lines") %>% 
  st_transform(crs = map_proj) %>% 
  st_geometry()
ne_state_lines <- read_sf("data/gis-data.gpkg", "ne_state_lines") %>% 
  st_transform(crs = map_proj) %>% 
  st_geometry()

# prepare ebird data for mapping
ebird_sf <- ebird %>% 
  # convert to spatial points
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>% 
  st_transform(crs = map_proj) %>% 
  select(species_observed)

# map
par(mar = c(0.25, 0.25, 0.25, 0.25))
# set up plot area
plot(st_geometry(ebird_sf), col = NA)
# contextual gis data
plot(ne_land, col = "#dddddd", border = "#888888", lwd = 0.5, add = TRUE)
plot(bcr, col = "#cccccc", border = NA, add = TRUE)
plot(ne_state_lines, col = "#ffffff", lwd = 0.75, add = TRUE)
plot(ne_country_lines, col = "#ffffff", lwd = 1.5, add = TRUE)
# ebird observations
# not observed
plot(st_geometry(ebird_sf),
     pch = 19, cex = 0.1, col = alpha("#555555", 0.25),
     add = TRUE)
# observed
plot(filter(ebird_sf, species_observed) %>% st_geometry(),
     pch = 19, cex = 0.3, col = alpha("#4daf4a", 1),
     add = TRUE)
# legend
legend("bottomright", bty = "n",
       col = c("#555555", "#4daf4a"),
       legend = c("eBird checklists", "Wood Thrush sightings"),
       pch = 19)
box()
par(new = TRUE, mar = c(0, 0, 3, 0))
title("Wood Thrush eBird Observations\nJune 2010-2019, BCR 27")
```
=======
This recommends getting the full ebird text file, but 
>>>>>>> 8ddaf72676f352482826582b05ee6c0209c69ffa
